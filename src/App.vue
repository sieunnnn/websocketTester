<template>
  <div id="app">
    <div class="title size">STOMP í…ŒìŠ¤íŠ¸ í•´ë³´ê¸°</div>
    <div class="size">
      <div> í”„ë¡ íŠ¸ íŒ€ì—ê²Œ STOMP ê¸°ëŠ¥ì„ ë„˜ê²¨ ì£¼ê¸°ì „, í…ŒìŠ¤íŠ¸ë¥¼ í•´ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. <br>
        í•˜ì§€ë§Œ í•´ë‹¹ í…ŒìŠ¤í„°ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” ê¸°ëŠ¥ì´ ì•„ë˜ì™€ ê°™ì€ ë¡œì§ì„ ê°€ì ¸ì•¼ í•©ë‹ˆë‹¤. <br>
      </div>
      <div style="margin-top: 10px">
        âœ… ì›¹ì†Œì¼“ í”„ë¡œí† ì½œë¡œ ë³€ê²½ ë˜ê¸° ì „, ë”± í•œë²ˆ prehandler ì—ì„œ í† í° ì¸ì¦ì„ ì‹œí–‰. <br>
        <div style="margin: 4px 0 10px 20px">
          í† í° ì¸ì¦ì„ ìœ„í•´ ì—°ê²° ì£¼ì†Œì— ì…ë ¥í•œ ê³³ìœ¼ë¡œ ìš”ì²­ì„ í•©ë‹ˆë‹¤.
        </div>
        âœ… ì›¹ì†Œì¼“ í”„ë¡œí† ì½œë¡œ ë³€ê²½ëœ í›„ì—ëŠ” í† í° ì¸ì¦ íŒ¨ìŠ¤. ğŸ™‹
      </div>
      <div style="margin-top: 20px; font-size: 16px">
        <span>í•´ë‹¹ í…ŒìŠ¤í„°ë¥¼ ì‚¬ìš© í•˜ê¸° ì „ì— </span>
        <span>
          <a href="https://github.com/sieunnnn/websocketTester">ì´ê³³</a>
        </span>
        <span>ì„ ë¨¼ì € ë°©ë¬¸í•´ì£¼ì„¸ìš”.</span>
      </div>
      <div style="margin-top: 10px; font-size: 14px; font-style: italic">
        <span style="font-weight: bold;">ë§Œì•½ ë„ì›€ì´ ë˜ì…¨ë‹¤ë©´ </span>
        <span>
          <a href="https://github.com/sieunnnn/websocketTester" style="font-weight: bold">ì´ê³³</a>
        </span>
        <span style="font-weight: bold">ì— ë°©ë¬¸í•˜ì—¬ ğŸŒŸ í•œë²ˆì”©ë§Œ ëˆŒëŸ¬ ì£¼ì„¸ìš”.</span><br>
        <span style="font-weight: bold">ê°œë°œì(ì·¨ì¤€ìƒ) ì—ê²Œ í° í˜ì´ ë©ë‹ˆë‹¤. ğŸ€</span>
      </div>
    </div>
    <div class="size">
      <n-h3 prefix="bar" style="margin: 40px 0 5px 0">
        <n-text type="primary">ì—°ê²° í•˜ê¸°</n-text>
      </n-h3>
      <div class="connect-container">
        <n-input-group-label style="margin-right: 5px">ğŸ”‘ ì—°ê²° ì£¼ì†Œ</n-input-group-label>
        <n-input v-model:value="connectionUrl" size="small" type="text" placeholder="ì›¹ì†Œì¼“ ì—°ê²°ì„ ìœ„í•œ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ë„£ì–´ì£¼ì„¸ìš”." :disabled="connected"/>
        <n-button :disabled="connected" n-button type="primary" @click="connect" style="margin-left: 10px">
          ì—°ê²° í•˜ê¸°
        </n-button>
      </div>
    </div>
    <div class="size">
      <n-h3 prefix="bar" style="margin: 20px 0 5px 0">
        <n-text type="primary">êµ¬ë… í•˜ê¸°</n-text>
      </n-h3>
      <div>êµ¬ë… ì£¼ì†Œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.</div>
      <div class="connect-container">
        <n-input-group-label style="margin-right: 5px">ğŸ”‘ êµ¬ë… ì£¼ì†Œ</n-input-group-label>
        <n-input v-model:value="subscriptionUrl" size="small" type="text" placeholder="êµ¬ë… ì£¼ì†Œë¥¼ ë„£ì–´ì£¼ì„¸ìš”." />
        <n-button type="primary" @click="subscribe" style="margin-left: 10px">
          êµ¬ë… í•˜ê¸°
        </n-button>
      </div>
      <div>
        <n-h3 prefix="bar" style="margin: 20px 0 5px 0">
          <n-text type="primary">ë°œí–‰ í•˜ê¸°</n-text>
        </n-h3>
        <div class="connect-container">
          <n-input-group-label style="margin-right: 5px">ğŸ“¨ ë°œí–‰ ì£¼ì†Œ</n-input-group-label>
          <n-input v-model:value="publishDestination" size="small" type="text" placeholder="ë°œí–‰ ì£¼ì†Œë¥¼ ë„£ì–´ì£¼ì„¸ìš”."/>
        </div>
        <div class="connect-container" style="margin-top: 10px">
          <n-input-group-label style="margin-right: 5px">ğŸ“· ì´ë¯¸ì§€ ì—…ë¡œë“œ</n-input-group-label>
          <input type="file" @change="handleFileChange" multiple />
        </div>
        <div class="connect-container" style="margin-top: 10px">
          <n-input-group-label style="margin-right: 5px">ğŸ“ƒ DTO(JSON)</n-input-group-label>
          <n-input v-model:value="messageContent" size="large" type="textarea" placeholder="JSON í˜•íƒœì˜ DTO ë¥¼ ë„£ì–´ ì£¼ì„¸ìš”." style="height: 250px"/>
        </div>
        <div class="size" style="display: flex; flex-direction: row; justify-content: flex-end; width: 100%">
          <n-button type="primary" @click="publish" style="width: 150px; margin-top: 10px">
            ë°œí–‰ í•˜ê¸°
          </n-button>
        </div>
      </div>
      <div>
        <div style="font-size: 18px; font-weight: bold; margin: 30px 0 10px 0">ğŸ“© êµ¬ë… ì£¼ì†Œë¡œ ì•„ë˜ì™€ ê°™ì´ ë©”ì„¸ì§€ê°€ ë„ì°© í•´ìš”.</div>
        <div class="json-container">
          <div v-for="(message, index) in formattedMessages" :key="index" style="margin: 30px">
            <vue-json-pretty theme="light" :data="message" />
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script lang="ts">
import { defineComponent, ref, computed } from 'vue';
import SockJS from 'sockjs-client';
import { Client, Message } from '@stomp/stompjs';
import VueJsonPretty from 'vue-json-pretty';
import 'vue-json-pretty/lib/styles.css';

export default defineComponent({
  components: {
    VueJsonPretty,
  },
  name: 'App',
  setup() {
    const connected = ref(false);
    const client = ref<Client | null>(null);
    const subscriptionUrl = ref('');
    const publishDestination = ref('');
    const messages = ref<string[]>([]);
    const messageContent = ref('');
    const connectionUrl = ref('');
    const selectedFiles = ref<File[]>([]);

    const connect = async () => {
      if (connected.value) {
        alert('ì´ë¯¸ ì—°ê²°ëœ ìƒíƒœì…ë‹ˆë‹¤.');
        return;
      }

      if (!connectionUrl.value) {
        alert('ì›¹ì†Œì¼“ ì—°ê²°ì„ ìœ„í•œ ì—”ë“œí¬ì¸íŠ¸ê°€ í•„ìš”í•´ìš”.');
        return;
      }

      const socketUrl = `${connectionUrl.value}`;

      try {
        const response = await fetch(socketUrl);
        if (!response.ok) {
          const error = await response.json();
          console.log(error.errorCode);
          return;
        }
      } catch (error) {
        console.error('HTTP ìš”ì²­ì— ì‹¤íŒ¨í–ˆì–´ìš”.:', error);
        return;
      }

      client.value = new Client({
        webSocketFactory: () => {
          const sock = new SockJS(socketUrl);
          sock.onclose = (event) => {
            console.error('ì›¹ì†Œì¼“ ì—°ê²°ì´ ëŠì–´ì¡Œì–´ìš”.:', event);
            alert('ì›¹ì†Œì¼“ ì—°ê²°ì´ ëŠì–´ì¡Œì–´ìš”: ' + event.reason);
          };
          return sock;
        },
        debug: (str) => {
          console.log(str);
        },
        reconnectDelay: 5000,
        heartbeatIncoming: 4000,
        heartbeatOutgoing: 4000,
      });

      client.value.onConnect = () => {
        console.log('ì›¹ì†Œì¼“ ì—°ê²° ì™„ë£Œ!');
        connected.value = true;
      };

      client.value.onDisconnect = () => {
        connected.value = false;
        console.log('ì›¹ì†Œì¼“ ì—°ê²° í•´ì œ');
      };

      client.value.onStompError = (frame) => {
        console.error('Broker ê°€ ì—ëŸ¬ë¥¼ ë°˜í™˜ í–ˆì–´ìš”.: ' + frame.headers['message']);
        console.error('ìƒì„¸ ì—ëŸ¬ë¬¸êµ¬: ' + frame.body);
      };

      client.value.activate();
    };

    const subscribe = () => {
      if (!client.value) {
        alert('ë¨¼ì € ì—°ê²°ì„ í•´ì£¼ì„¸ìš”.');
        return;
      }

      if (!subscriptionUrl.value) {
        alert('êµ¬ë… ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      client.value.subscribe(subscriptionUrl.value, (message: Message) => {
        messages.value.push(message.body);
      });
    };

    const handleFileChange = (event: Event) => {
      const input = event.target as HTMLInputElement;
      if (input && input.files) {
        selectedFiles.value = Array.from(input.files);
        console.log('Selected files:', selectedFiles.value);
      } else {
        console.error('No files found in the input event.');
      }
    };

    const publish = async () => {
      if (!client.value || !publishDestination.value || !messageContent.value) {
        alert('ë°œí–‰ ì£¼ì†Œì™€ ë©”ì‹œì§€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      let encodedFiles: { name: string, content: string }[] = [];

      if (selectedFiles.value.length > 0) {
        encodedFiles = await Promise.all(
            selectedFiles.value.map((file) => {
              return new Promise<{ name: string; content: string }>((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                  resolve({ name: file.name, content: reader.result as string });
                };
                reader.onerror = (error) => {
                  console.error('FileReader error:', error);
                  reject(error);
                };
                reader.readAsDataURL(file);
              });
            })
        );
      }

      const messageObject = JSON.parse(messageContent.value);
      messageObject.images = encodedFiles.length > 0 ? encodedFiles : null;

      console.log('Sending message object:', messageObject);

      client.value.publish({
        destination: publishDestination.value,
        body: JSON.stringify(messageObject),
        headers: { 'Content-Type': 'application/json' },
      });
    };

    const formattedMessages = computed(() => {
      return messages.value.map((message) => {
        try {
          return JSON.parse(message);
        } catch (e) {
          return { error: 'JSON í˜•íƒœê°€ ì•„ë‹ˆì—ìš”. ë‹¤ì‹œ í•œë²ˆ í™•ì¸ í•´ì£¼ì„¸ìš”.' };
        }
      });
    });

    return {
      connected,
      subscriptionUrl,
      publishDestination,
      messages,
      messageContent,
      connectionUrl,
      connect,
      subscribe,
      publish,
      handleFileChange,
      formattedMessages,
    };
  },
});
</script>

<style>
#app {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 100%;
  height: 100%;
  overflow-x: hidden;
}

.title {
  font-family: 'GangwonEduPowerExtraBoldA';
  font-size: 35px;
  margin-top: 60px;
}

.connect-container {
  display: flex;
  flex-direction: row;
  width: 100%;
  height: auto;
}

.json-container {
  width: 100%;
  height: 550px;
  border-radius: 5px;
  background-color: #f1f3f5;
  overflow-y: scroll;
  margin-bottom: 40px;
}

.size {
  width: 90%;
  height: 100%;
}

a {
  &:visited {
    color: green;
  }
}
</style>
